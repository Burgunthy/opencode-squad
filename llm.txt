# OpenCode Agent Teams Plugin - LLM Context

## Project Overview

This is an OpenCode plugin that provides multi-agent team collaboration capabilities, designed to match Claude Code's agent-teams functionality.

## Architecture

```
~/.config/opencode/
â”œâ”€â”€ opencode.json              # Main config with 30+ agent definitions
â”œâ”€â”€ agents/                    # Subagent markdown files (100+)
â”‚   â””â”€â”€ *.md                   # YAML frontmatter + prompts
â”œâ”€â”€ skills/                    # Skill definitions
â””â”€â”€ plugins/
    â””â”€â”€ agent-teams/           # This plugin
        â”œâ”€â”€ src/index.ts       # Main plugin code
        â””â”€â”€ dist/index.js      # Compiled output
```

## Agent Definition Sources

### 1. opencode.json (Primary - Used by Plugin)

```json
{
  "agent": {
    "debugger": {
      "description": "Expert debugger specializing in...",
      "model": "zai-coding-plan/glm-4.7",
      "tools": {
        "read": true,
        "write": true,
        "edit": true,
        "bash": true,
        "glob": true,
        "grep": true,
        "webfetch": true,
        "websearch": true
      },
      "prompt_append": "You are an expert debugger..."
    }
  }
}
```

### 2. agents/*.md (Subagent Definitions)

```yaml
---
description: Expert debugger...
mode: subagent
model: zai-coding-plan/glm-4.7
tools:
  read: true
  write: true
  edit: true
  bash: true
  glob: true
  grep: true
permission:
  bash:
    '*': allow
  edit: allow
  write: allow
---

You are a senior debugging specialist...
```

**Note**: Plugin currently reads from `opencode.json`. To use agents from `agents/*.md`, they must be added to `opencode.json`.

## Plugin Implementation

### Agent Loading

```typescript
function loadOpenCodeAgents(): Record<string, { role: string; description: string }> {
  const configPath = path.join(process.cwd(), "opencode.json");
  const config = JSON.parse(fs.readFileSync(configPath, "utf-8"));

  const agents: Record<string, { role: string; description: string }> = {};

  if (config.agent) {
    for (const [name, def] of Object.entries(config.agent)) {
      agents[name] = {
        role: def.description?.split(".")[0] || name,
        description: def.description || ""
      };
    }
  }

  return agents;
}
```

### Tools

| Tool | Description |
|------|-------------|
| `team-spawn` | Create agent team with preset or custom agents |
| `team-discuss` | Run parallel discussion between agents |
| `team-status` | Check team status |
| `team-shutdown` | Remove team |
| `team-auto` | Natural language team request |

### State Management

```typescript
interface Agent {
  name: string;
  sessionID: string;
  role: string;
  status: "idle" | "thinking" | "responding";
}

interface Team {
  id: string;
  name: string;
  preset: string;
  agents: Map<string, Agent>;
  createdAt: Date;
}

const teams = new Map<string, Team>();
```

### Parallel Execution

```typescript
const results = await Promise.all(
  agents.map(agent => executeAgent(agent, prompt))
);
```

## Presets

```typescript
const PRESETS: Record<string, string[]> = {
  "review": ["code-reviewer", "security-auditor", "devil-s-advocate"],
  "security": ["security-auditor", "devil-s-advocate"],
  "debug": ["debugger", "devil-s-advocate"],
  "planning": ["planner", "devil-s-advocate"],
  "implementation": ["backend-developer", "frontend-developer", "test-automator", "devil-s-advocate"],
  "fullstack": ["fullstack-developer", "devil-s-advocate"]
};
```

## Available Agents in opencode.json

| Category | Agents |
|----------|--------|
| **Core** | team-lead, devil-s-advocate, general-purpose |
| **Development** | python-pro, typescript-pro, golang-pro, rust-engineer |
| **Web** | frontend-developer, backend-developer, fullstack-developer, react-specialist, nextjs-developer |
| **AI/ML** | ai-engineer, data-scientist, ml-engineer, llm-architect, prompt-engineer |
| **DevOps** | devops-engineer, database-administrator, performance-engineer |
| **Quality** | code-reviewer, security-auditor, debugger, test-automator, tdd-guide |
| **Planning** | planner, refactoring-specialist, error-detective, explore |
| **Special** | mcp-developer, api-designer, ui-designer |

## Agent Permission Patterns

### Full Access Agents
```json
{
  "tools": {
    "read": true, "write": true, "edit": true, "bash": true,
    "glob": true, "grep": true, "webfetch": true, "websearch": true
  }
}
```

### Read-Only Review Agents
```json
{
  "tools": {
    "read": true, "glob": true, "grep": true, "bash": true,
    "webfetch": true, "websearch": true,
    "edit": false, "write": false
  }
}
```

### Devil's Advocate (Critical Reviewer)
```json
{
  "tools": {
    "read": true, "glob": true, "grep": true,
    "webfetch": true, "websearch": true,
    "write": false, "edit": false, "bash": false
  }
}
```

## Usage Patterns

### Natural Language
```
Input: "ì´ ì½”ë“œë¥¼ íŒ€ì„ ì§œì„œ ë³´ì•ˆ ê²€í† í•´ì¤˜"
â†’ Detects "ë³´ì•ˆ" â†’ Uses "security" preset
â†’ Creates team with security-auditor + devil-s-advocate
```

### Manual
```
/team-spawn preset="review" teamName="auth-review" task="ì½”ë“œ ë¦¬ë·°"
/team-discuss teamId="team-xxx" topic="SQL injection"
```

## Compatibility with oh-my-opencode

Both plugins can be used together:

```json
{
  "plugin": [
    "opencode-sessions",
    "oh-my-opencode",
    "./plugins/agent-teams"
  ]
}
```

| Plugin | Provides |
|--------|----------|
| **oh-my-opencode** | Oracle, Librarian, custom agents |
| **agent-teams** | Multi-agent collaboration, presets |

No conflicts - both work independently.

## Output Format

```
## Team "name" Created ğŸ”€

**Team ID**: team-xxx
**Preset**: review
**Source**: OpenCode config

### Agents (N)
- **agent-name** (Role) âœ“  // âœ“ = defined in opencode.json

### Task
...

---

## Discussion

### Round 1

**agent-1**:
- Finding 1
- Finding 2

**devil-s-advocate**:
### What Others Missed
1. Issue not found by others
```

## Error Handling

- Invalid preset â†’ Falls back to "review"
- Missing teamId â†’ Returns error message
- Unknown agent â†’ Uses generic agent with name as role, logs warning

## Dependencies

```json
{
  "dependencies": {
    "@opencode-ai/plugin": "^1.1.60",
    "@opencode-ai/sdk": "^1.1.60",
    "zod": "^4.1.8"
  }
}
```

## Build

```bash
bun install
bun run build  # Outputs to dist/index.js
```

## Key Constraints

1. **Devil's Advocate Required**: Every preset includes devil-s-advocate
2. **Max Team Size**: No hard limit (configurable)
3. **Memory-Based State**: Teams stored in Map, not persisted
4. **Zod Compatibility**: Must use `tool.schema` for type safety

## Extending the Plugin

### Add New Agent to opencode.json
```json
{
  "agent": {
    "my-agent": {
      "description": "Custom agent description",
      "model": "zai-coding-plan/glm-4.7",
      "tools": { "read": true, "write": true }
    }
  }
}
```

### Add New Preset
```typescript
// In src/index.ts
const PRESETS: Record<string, string[]> = {
  // ...existing
  "my-preset": ["my-agent", "devil-s-advocate"]
};
```

## Future Enhancements

- [ ] Load agents from `agents/*.md` files
- [ ] Task dependencies (blocks/blockedBy)
- [ ] Message protocol between agents
- [ ] Persistent team state
- [ ] Agent status tracking (thinking/responding)
